const jwt = require("jsonwebtoken");
const bcryptjs = require("bcryptjs");
const helperWrapper = require("../../helper/wrapper");
const authModel = require("./userModel");
require("dotenv").config();
module.exports = {
  register: async (req, res) => {
    try {
      const {
        namaDepan,
        namaBelakang,
        email,
        password,
        point,
        karakter
      } = req.body;

      // PROSES PENGECEKAN EMAIL SUDAH PERNAH TERDAFTAR ATAU BLM DI DATABASE
      const checkUser = await authModel.getUserByEmail(email);
      if (checkUser.length > 0) {
        return helperWrapper.response(res, 409, `Email already used`, null);
      }

      // Proses Validasi input form
      if (email.length < 1 || password.length < 1) {
        return helperWrapper.response(res, 400, "All input must be filled", null);
      }

      // PROSES ENCRYPT PASSWORD
      const hashPassword = await bcryptjs.hash(password, 10);
      const setData = {
        namaDepan,
        namaBelakang,
        email,
        password: hashPassword,
        point,
        karakter,
        createdat: new Date(Date.now())
      };
      const result = await authModel.register(setData);
      // await sendMail(setDataMail);
      return helperWrapper.response(res, 200, "Success register user, please verify your email", result);
    } catch (error) {
      return helperWrapper.response(res, 400, `Bad Request, ${error.message}`, null);
    }
  },
  login: async (req, res) => {
    try {
      const {
        email,
        password
      } = req.body;
      const checkUser = await authModel.getUserByEmail(email);
      console.log(checkUser);

      // Proses Validasi input form
      if (email.length < 1 || password.length < 1) {
        return helperWrapper.response(res, 400, "All input must be filled", null);
      }
      const passwordUser = await bcryptjs.compare(password, checkUser[0].password);
      if (!passwordUser) {
        return helperWrapper.response(res, 400, "Wrong password", null);
      }

      // PROSES UTAMA MEMBUAT TOKEN MENGGUNAKAN JWT (DATA YANG MAU DIUBAH, KATA KUNCI, LAMA TOKEN BISA DIGUNAKAN )
      const payload = checkUser[0];
      delete payload.password;
      const token = jwt.sign({
        ...payload
      }, "RAHASIA", {
        expiresIn: "24h"
      });
      // Add refresh token
      const refreshToken = jwt.sign({
        ...payload
      }, "RAHASIA", {
        expiresIn: "72h"
      });
      return helperWrapper.response(res, 200, "Success login", {
        id: payload.id,
        token,
        refreshToken,
        name: payload.namaDepan + payload.namaBelakang,
        namaPengguna: payload.namaDepan,
        email: payload.email,
        alamat: payload.alamat,
        tentang: payload.tentang,
        createdby: payload.createdBy,
        char: payload.karakter,
        point: payload.point
      });
    } catch (error) {
      return helperWrapper.response(res, 400, `Bad request (${error.message})`, null);
    }
  },
  getUserId: async (req, res) => {
    try {
      const {
        id
      } = req.params;
      const result = await authModel.getUserId(id);
      if (result.length < 1) {
        return helperWrapper.response(res, 404, `data by id ${idUser} not found !`, null);
      }
      return helperWrapper.response(res, 200, "succes get data by id", result);
    } catch (error) {
      return helperWrapper.response(res, 400, `bad request (${error.message})`, null);
    }
  },
  getAllUser: async (req, res) => {
    try {
      let {
        page,
        limit,
        search,
        sort
      } = req.query;
      page = Number(page) || 1;
      limit = Number(limit) || 10;
      search = search || "";
      sort = sort || "point DESC";
      let offset = page * limit - limit;
      const totalData = await authModel.getCountUser(search);
      const totalPage = Math.ceil(totalData / limit);
      if (totalPage < page) {
        offset = 0;
        page = 1;
      }
      const pageInfo = {
        page,
        totalPage,
        limit,
        totalData
      };
      const result = await authModel.getAllUser(limit, offset, search, sort);
      if (result.length < 1) {
        return helperWrapper.response(res, 200, `Data not found !`, []);
      }
      return helperWrapper.response(res, 200, "Success get data", result, pageInfo);
    } catch (error) {
      return helperWrapper.response(res, 400, `Bad request (${error.message})`, null);
    }
  },
  updateUser: async (req, res) => {
    try {
      const {
        id
      } = req.params;
      const checkId = await authModel.updateUser;
      if (checkId.length < 1) {
        return helperWrapper.response(res, 404, `data by id ${id} not found !`, null);
      }
      const {
        point
      } = req.body;
      const setData = {
        point
      };
      // untuk mengupdate salah satu field saja
      Object.keys(setData).forEach(data => {
        if (!setData[data]) {
          delete setData[data];
        }
      });
      const result = await authModel.updateUser(setData, id);
      return helperWrapper.response(res, 200, "succes update data", result);
    } catch (error) {
      return helperWrapper.response(res, 400, `bad request (${error.message})`, null);
    }
  },
  updateGambar: async (req, res) => {
    try {
      const {
        id
      } = req.params;
      const checkId = await authModel.updateUser;
      if (checkId.length < 1) {
        return helperWrapper.response(res, 404, `data by id ${id} not found !`, null);
      }
      const {
        karakter
      } = req.body;
      const setData = {
        karakter
      };
      // untuk mengupdate salah satu field saja
      Object.keys(setData).forEach(data => {
        if (!setData[data]) {
          delete setData[data];
        }
      });
      const result = await authModel.updateUser(setData, id);
      return helperWrapper.response(res, 200, "succes update data", result);
    } catch (error) {
      return helperWrapper.response(res, 400, `bad request (${error.message})`, null);
    }
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJqd3QiLCJyZXF1aXJlIiwiYmNyeXB0anMiLCJoZWxwZXJXcmFwcGVyIiwiYXV0aE1vZGVsIiwiY29uZmlnIiwibW9kdWxlIiwiZXhwb3J0cyIsInJlZ2lzdGVyIiwicmVxIiwicmVzIiwibmFtYURlcGFuIiwibmFtYUJlbGFrYW5nIiwiZW1haWwiLCJwYXNzd29yZCIsInBvaW50Iiwia2FyYWt0ZXIiLCJib2R5IiwiY2hlY2tVc2VyIiwiZ2V0VXNlckJ5RW1haWwiLCJsZW5ndGgiLCJyZXNwb25zZSIsImhhc2hQYXNzd29yZCIsImhhc2giLCJzZXREYXRhIiwiY3JlYXRlZGF0IiwiRGF0ZSIsIm5vdyIsInJlc3VsdCIsImVycm9yIiwibWVzc2FnZSIsImxvZ2luIiwiY29uc29sZSIsImxvZyIsInBhc3N3b3JkVXNlciIsImNvbXBhcmUiLCJwYXlsb2FkIiwidG9rZW4iLCJzaWduIiwiZXhwaXJlc0luIiwicmVmcmVzaFRva2VuIiwiaWQiLCJuYW1lIiwibmFtYVBlbmdndW5hIiwiYWxhbWF0IiwidGVudGFuZyIsImNyZWF0ZWRieSIsImNyZWF0ZWRCeSIsImNoYXIiLCJnZXRVc2VySWQiLCJwYXJhbXMiLCJpZFVzZXIiLCJnZXRBbGxVc2VyIiwicGFnZSIsImxpbWl0Iiwic2VhcmNoIiwic29ydCIsInF1ZXJ5IiwiTnVtYmVyIiwib2Zmc2V0IiwidG90YWxEYXRhIiwiZ2V0Q291bnRVc2VyIiwidG90YWxQYWdlIiwiTWF0aCIsImNlaWwiLCJwYWdlSW5mbyIsInVwZGF0ZVVzZXIiLCJjaGVja0lkIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJkYXRhIiwidXBkYXRlR2FtYmFyIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL21vZHVsZXMvdXNlci91c2VyQ29udHJvbGxlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBqd3QgPSByZXF1aXJlKFwianNvbndlYnRva2VuXCIpO1xyXG5jb25zdCBiY3J5cHRqcyA9IHJlcXVpcmUoXCJiY3J5cHRqc1wiKTtcclxuY29uc3QgaGVscGVyV3JhcHBlciA9IHJlcXVpcmUoXCIuLi8uLi9oZWxwZXIvd3JhcHBlclwiKTtcclxuY29uc3QgYXV0aE1vZGVsID0gcmVxdWlyZShcIi4vdXNlck1vZGVsXCIpO1xyXG5yZXF1aXJlKFwiZG90ZW52XCIpLmNvbmZpZygpO1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgcmVnaXN0ZXI6IGFzeW5jIChyZXEsIHJlcykgPT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgeyBuYW1hRGVwYW4sIG5hbWFCZWxha2FuZywgZW1haWwsIHBhc3N3b3JkLCBwb2ludCwga2FyYWt0ZXIgfSA9XHJcbiAgICAgICAgcmVxLmJvZHk7XHJcblxyXG4gICAgICAvLyBQUk9TRVMgUEVOR0VDRUtBTiBFTUFJTCBTVURBSCBQRVJOQUggVEVSREFGVEFSIEFUQVUgQkxNIERJIERBVEFCQVNFXHJcbiAgICAgIGNvbnN0IGNoZWNrVXNlciA9IGF3YWl0IGF1dGhNb2RlbC5nZXRVc2VyQnlFbWFpbChlbWFpbCk7XHJcbiAgICAgIGlmIChjaGVja1VzZXIubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIHJldHVybiBoZWxwZXJXcmFwcGVyLnJlc3BvbnNlKHJlcywgNDA5LCBgRW1haWwgYWxyZWFkeSB1c2VkYCwgbnVsbCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIFByb3NlcyBWYWxpZGFzaSBpbnB1dCBmb3JtXHJcbiAgICAgIGlmIChlbWFpbC5sZW5ndGggPCAxIHx8IHBhc3N3b3JkLmxlbmd0aCA8IDEpIHtcclxuICAgICAgICByZXR1cm4gaGVscGVyV3JhcHBlci5yZXNwb25zZShcclxuICAgICAgICAgIHJlcyxcclxuICAgICAgICAgIDQwMCxcclxuICAgICAgICAgIFwiQWxsIGlucHV0IG11c3QgYmUgZmlsbGVkXCIsXHJcbiAgICAgICAgICBudWxsXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gUFJPU0VTIEVOQ1JZUFQgUEFTU1dPUkRcclxuICAgICAgY29uc3QgaGFzaFBhc3N3b3JkID0gYXdhaXQgYmNyeXB0anMuaGFzaChwYXNzd29yZCwgMTApO1xyXG4gICAgICBjb25zdCBzZXREYXRhID0ge1xyXG4gICAgICAgIG5hbWFEZXBhbixcclxuICAgICAgICBuYW1hQmVsYWthbmcsXHJcbiAgICAgICAgZW1haWwsXHJcbiAgICAgICAgcGFzc3dvcmQ6IGhhc2hQYXNzd29yZCxcclxuICAgICAgICBwb2ludCxcclxuICAgICAgICBrYXJha3RlcixcclxuICAgICAgICBjcmVhdGVkYXQ6IG5ldyBEYXRlKERhdGUubm93KCkpLFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYXV0aE1vZGVsLnJlZ2lzdGVyKHNldERhdGEpO1xyXG4gICAgICAvLyBhd2FpdCBzZW5kTWFpbChzZXREYXRhTWFpbCk7XHJcbiAgICAgIHJldHVybiBoZWxwZXJXcmFwcGVyLnJlc3BvbnNlKFxyXG4gICAgICAgIHJlcyxcclxuICAgICAgICAyMDAsXHJcbiAgICAgICAgXCJTdWNjZXNzIHJlZ2lzdGVyIHVzZXIsIHBsZWFzZSB2ZXJpZnkgeW91ciBlbWFpbFwiLFxyXG4gICAgICAgIHJlc3VsdFxyXG4gICAgICApO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgcmV0dXJuIGhlbHBlcldyYXBwZXIucmVzcG9uc2UoXHJcbiAgICAgICAgcmVzLFxyXG4gICAgICAgIDQwMCxcclxuICAgICAgICBgQmFkIFJlcXVlc3QsICR7ZXJyb3IubWVzc2FnZX1gLFxyXG4gICAgICAgIG51bGxcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9LFxyXG4gIGxvZ2luOiBhc3luYyAocmVxLCByZXMpID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHsgZW1haWwsIHBhc3N3b3JkIH0gPSByZXEuYm9keTtcclxuICAgICAgY29uc3QgY2hlY2tVc2VyID0gYXdhaXQgYXV0aE1vZGVsLmdldFVzZXJCeUVtYWlsKGVtYWlsKTtcclxuICAgICAgY29uc29sZS5sb2coY2hlY2tVc2VyKTtcclxuXHJcbiAgICAgIC8vIFByb3NlcyBWYWxpZGFzaSBpbnB1dCBmb3JtXHJcbiAgICAgIGlmIChlbWFpbC5sZW5ndGggPCAxIHx8IHBhc3N3b3JkLmxlbmd0aCA8IDEpIHtcclxuICAgICAgICByZXR1cm4gaGVscGVyV3JhcHBlci5yZXNwb25zZShcclxuICAgICAgICAgIHJlcyxcclxuICAgICAgICAgIDQwMCxcclxuICAgICAgICAgIFwiQWxsIGlucHV0IG11c3QgYmUgZmlsbGVkXCIsXHJcbiAgICAgICAgICBudWxsXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgcGFzc3dvcmRVc2VyID0gYXdhaXQgYmNyeXB0anMuY29tcGFyZShcclxuICAgICAgICBwYXNzd29yZCxcclxuICAgICAgICBjaGVja1VzZXJbMF0ucGFzc3dvcmRcclxuICAgICAgKTtcclxuICAgICAgaWYgKCFwYXNzd29yZFVzZXIpIHtcclxuICAgICAgICByZXR1cm4gaGVscGVyV3JhcHBlci5yZXNwb25zZShyZXMsIDQwMCwgXCJXcm9uZyBwYXNzd29yZFwiLCBudWxsKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gUFJPU0VTIFVUQU1BIE1FTUJVQVQgVE9LRU4gTUVOR0dVTkFLQU4gSldUIChEQVRBIFlBTkcgTUFVIERJVUJBSCwgS0FUQSBLVU5DSSwgTEFNQSBUT0tFTiBCSVNBIERJR1VOQUtBTiApXHJcbiAgICAgIGNvbnN0IHBheWxvYWQgPSBjaGVja1VzZXJbMF07XHJcbiAgICAgIGRlbGV0ZSBwYXlsb2FkLnBhc3N3b3JkO1xyXG4gICAgICBjb25zdCB0b2tlbiA9IGp3dC5zaWduKHsgLi4ucGF5bG9hZCB9LCBcIlJBSEFTSUFcIiwge1xyXG4gICAgICAgIGV4cGlyZXNJbjogXCIyNGhcIixcclxuICAgICAgfSk7XHJcbiAgICAgIC8vIEFkZCByZWZyZXNoIHRva2VuXHJcbiAgICAgIGNvbnN0IHJlZnJlc2hUb2tlbiA9IGp3dC5zaWduKHsgLi4ucGF5bG9hZCB9LCBcIlJBSEFTSUFcIiwge1xyXG4gICAgICAgIGV4cGlyZXNJbjogXCI3MmhcIixcclxuICAgICAgfSk7XHJcbiAgICAgIHJldHVybiBoZWxwZXJXcmFwcGVyLnJlc3BvbnNlKHJlcywgMjAwLCBcIlN1Y2Nlc3MgbG9naW5cIiwge1xyXG4gICAgICAgIGlkOiBwYXlsb2FkLmlkLFxyXG4gICAgICAgIHRva2VuLFxyXG4gICAgICAgIHJlZnJlc2hUb2tlbixcclxuICAgICAgICBuYW1lOiBwYXlsb2FkLm5hbWFEZXBhbiArIHBheWxvYWQubmFtYUJlbGFrYW5nLFxyXG4gICAgICAgIG5hbWFQZW5nZ3VuYTogcGF5bG9hZC5uYW1hRGVwYW4sXHJcbiAgICAgICAgZW1haWw6IHBheWxvYWQuZW1haWwsXHJcbiAgICAgICAgYWxhbWF0OiBwYXlsb2FkLmFsYW1hdCxcclxuICAgICAgICB0ZW50YW5nOiBwYXlsb2FkLnRlbnRhbmcsXHJcbiAgICAgICAgY3JlYXRlZGJ5OiBwYXlsb2FkLmNyZWF0ZWRCeSxcclxuICAgICAgICBjaGFyOiBwYXlsb2FkLmthcmFrdGVyLFxyXG4gICAgICAgIHBvaW50OiBwYXlsb2FkLnBvaW50LFxyXG4gICAgICB9KTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIHJldHVybiBoZWxwZXJXcmFwcGVyLnJlc3BvbnNlKFxyXG4gICAgICAgIHJlcyxcclxuICAgICAgICA0MDAsXHJcbiAgICAgICAgYEJhZCByZXF1ZXN0ICgke2Vycm9yLm1lc3NhZ2V9KWAsXHJcbiAgICAgICAgbnVsbFxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgZ2V0VXNlcklkOiBhc3luYyAocmVxLCByZXMpID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGF1dGhNb2RlbC5nZXRVc2VySWQoaWQpO1xyXG4gICAgICBpZiAocmVzdWx0Lmxlbmd0aCA8IDEpIHtcclxuICAgICAgICByZXR1cm4gaGVscGVyV3JhcHBlci5yZXNwb25zZShcclxuICAgICAgICAgIHJlcyxcclxuICAgICAgICAgIDQwNCxcclxuICAgICAgICAgIGBkYXRhIGJ5IGlkICR7aWRVc2VyfSBub3QgZm91bmQgIWAsXHJcbiAgICAgICAgICBudWxsXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIGhlbHBlcldyYXBwZXIucmVzcG9uc2UocmVzLCAyMDAsIFwic3VjY2VzIGdldCBkYXRhIGJ5IGlkXCIsIHJlc3VsdCk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICByZXR1cm4gaGVscGVyV3JhcHBlci5yZXNwb25zZShcclxuICAgICAgICByZXMsXHJcbiAgICAgICAgNDAwLFxyXG4gICAgICAgIGBiYWQgcmVxdWVzdCAoJHtlcnJvci5tZXNzYWdlfSlgLFxyXG4gICAgICAgIG51bGxcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9LFxyXG4gIGdldEFsbFVzZXI6IGFzeW5jIChyZXEsIHJlcykgPT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgbGV0IHsgcGFnZSwgbGltaXQsIHNlYXJjaCwgc29ydCB9ID0gcmVxLnF1ZXJ5O1xyXG4gICAgICBwYWdlID0gTnVtYmVyKHBhZ2UpIHx8IDE7XHJcbiAgICAgIGxpbWl0ID0gTnVtYmVyKGxpbWl0KSB8fCAxMDtcclxuICAgICAgc2VhcmNoID0gc2VhcmNoIHx8IFwiXCI7XHJcbiAgICAgIHNvcnQgPSBzb3J0IHx8IFwicG9pbnQgREVTQ1wiO1xyXG5cclxuICAgICAgbGV0IG9mZnNldCA9IHBhZ2UgKiBsaW1pdCAtIGxpbWl0O1xyXG4gICAgICBjb25zdCB0b3RhbERhdGEgPSBhd2FpdCBhdXRoTW9kZWwuZ2V0Q291bnRVc2VyKHNlYXJjaCk7XHJcbiAgICAgIGNvbnN0IHRvdGFsUGFnZSA9IE1hdGguY2VpbCh0b3RhbERhdGEgLyBsaW1pdCk7XHJcblxyXG4gICAgICBpZiAodG90YWxQYWdlIDwgcGFnZSkge1xyXG4gICAgICAgIG9mZnNldCA9IDA7XHJcbiAgICAgICAgcGFnZSA9IDE7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IHBhZ2VJbmZvID0ge1xyXG4gICAgICAgIHBhZ2UsXHJcbiAgICAgICAgdG90YWxQYWdlLFxyXG4gICAgICAgIGxpbWl0LFxyXG4gICAgICAgIHRvdGFsRGF0YSxcclxuICAgICAgfTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGF1dGhNb2RlbC5nZXRBbGxVc2VyKGxpbWl0LCBvZmZzZXQsIHNlYXJjaCwgc29ydCk7XHJcblxyXG4gICAgICBpZiAocmVzdWx0Lmxlbmd0aCA8IDEpIHtcclxuICAgICAgICByZXR1cm4gaGVscGVyV3JhcHBlci5yZXNwb25zZShyZXMsIDIwMCwgYERhdGEgbm90IGZvdW5kICFgLCBbXSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiBoZWxwZXJXcmFwcGVyLnJlc3BvbnNlKFxyXG4gICAgICAgIHJlcyxcclxuICAgICAgICAyMDAsXHJcbiAgICAgICAgXCJTdWNjZXNzIGdldCBkYXRhXCIsXHJcbiAgICAgICAgcmVzdWx0LFxyXG4gICAgICAgIHBhZ2VJbmZvXHJcbiAgICAgICk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICByZXR1cm4gaGVscGVyV3JhcHBlci5yZXNwb25zZShcclxuICAgICAgICByZXMsXHJcbiAgICAgICAgNDAwLFxyXG4gICAgICAgIGBCYWQgcmVxdWVzdCAoJHtlcnJvci5tZXNzYWdlfSlgLFxyXG4gICAgICAgIG51bGxcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9LFxyXG4gIHVwZGF0ZVVzZXI6IGFzeW5jIChyZXEsIHJlcykgPT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcclxuICAgICAgY29uc3QgY2hlY2tJZCA9IGF3YWl0IGF1dGhNb2RlbC51cGRhdGVVc2VyO1xyXG4gICAgICBpZiAoY2hlY2tJZC5sZW5ndGggPCAxKSB7XHJcbiAgICAgICAgcmV0dXJuIGhlbHBlcldyYXBwZXIucmVzcG9uc2UoXHJcbiAgICAgICAgICByZXMsXHJcbiAgICAgICAgICA0MDQsXHJcbiAgICAgICAgICBgZGF0YSBieSBpZCAke2lkfSBub3QgZm91bmQgIWAsXHJcbiAgICAgICAgICBudWxsXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCB7IHBvaW50IH0gPSByZXEuYm9keTtcclxuICAgICAgY29uc3Qgc2V0RGF0YSA9IHtcclxuICAgICAgICBwb2ludCxcclxuICAgICAgfTtcclxuICAgICAgLy8gdW50dWsgbWVuZ3VwZGF0ZSBzYWxhaCBzYXR1IGZpZWxkIHNhamFcclxuICAgICAgT2JqZWN0LmtleXMoc2V0RGF0YSkuZm9yRWFjaCgoZGF0YSkgPT4ge1xyXG4gICAgICAgIGlmICghc2V0RGF0YVtkYXRhXSkge1xyXG4gICAgICAgICAgZGVsZXRlIHNldERhdGFbZGF0YV07XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYXV0aE1vZGVsLnVwZGF0ZVVzZXIoc2V0RGF0YSwgaWQpO1xyXG4gICAgICByZXR1cm4gaGVscGVyV3JhcHBlci5yZXNwb25zZShyZXMsIDIwMCwgXCJzdWNjZXMgdXBkYXRlIGRhdGFcIiwgcmVzdWx0KTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIHJldHVybiBoZWxwZXJXcmFwcGVyLnJlc3BvbnNlKFxyXG4gICAgICAgIHJlcyxcclxuICAgICAgICA0MDAsXHJcbiAgICAgICAgYGJhZCByZXF1ZXN0ICgke2Vycm9yLm1lc3NhZ2V9KWAsXHJcbiAgICAgICAgbnVsbFxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgdXBkYXRlR2FtYmFyOiBhc3luYyAocmVxLCByZXMpID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XHJcbiAgICAgIGNvbnN0IGNoZWNrSWQgPSBhd2FpdCBhdXRoTW9kZWwudXBkYXRlVXNlcjtcclxuICAgICAgaWYgKGNoZWNrSWQubGVuZ3RoIDwgMSkge1xyXG4gICAgICAgIHJldHVybiBoZWxwZXJXcmFwcGVyLnJlc3BvbnNlKFxyXG4gICAgICAgICAgcmVzLFxyXG4gICAgICAgICAgNDA0LFxyXG4gICAgICAgICAgYGRhdGEgYnkgaWQgJHtpZH0gbm90IGZvdW5kICFgLFxyXG4gICAgICAgICAgbnVsbFxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgeyBrYXJha3RlciB9ID0gcmVxLmJvZHk7XHJcbiAgICAgIGNvbnN0IHNldERhdGEgPSB7XHJcbiAgICAgICAga2FyYWt0ZXIsXHJcbiAgICAgIH07XHJcbiAgICAgIC8vIHVudHVrIG1lbmd1cGRhdGUgc2FsYWggc2F0dSBmaWVsZCBzYWphXHJcbiAgICAgIE9iamVjdC5rZXlzKHNldERhdGEpLmZvckVhY2goKGRhdGEpID0+IHtcclxuICAgICAgICBpZiAoIXNldERhdGFbZGF0YV0pIHtcclxuICAgICAgICAgIGRlbGV0ZSBzZXREYXRhW2RhdGFdO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGF1dGhNb2RlbC51cGRhdGVVc2VyKHNldERhdGEsIGlkKTtcclxuICAgICAgcmV0dXJuIGhlbHBlcldyYXBwZXIucmVzcG9uc2UocmVzLCAyMDAsIFwic3VjY2VzIHVwZGF0ZSBkYXRhXCIsIHJlc3VsdCk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICByZXR1cm4gaGVscGVyV3JhcHBlci5yZXNwb25zZShcclxuICAgICAgICByZXMsXHJcbiAgICAgICAgNDAwLFxyXG4gICAgICAgIGBiYWQgcmVxdWVzdCAoJHtlcnJvci5tZXNzYWdlfSlgLFxyXG4gICAgICAgIG51bGxcclxuICAgICAgKTtcclxuICAgIH1cclxu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